<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>
    <%= (typeof titulo !== 'undefined' && titulo)
        ? (titulo + ' • Wyvern')
        : ((typeof title !== 'undefined' && title)
            ? (title + ' • Wyvern')
            : 'Wyvern') %>
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Cinzel+Decorative:wght@700&family=Lora:wght@400;600&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css">

  <link rel="stylesheet" href="/css/app.css?v=2025-11-05">
</head>

<body>
  <div class="app-shell d-flex" id="appShell">
    
    <aside id="sidebar-menu" class="sidebar">
      <div class="sidebar-header px-3 py-2">
        <a href="/" class="app-logo text-decoration-none text-white fw-bold d-flex align-items-center">
          <i class="bi bi-dice-5 fs-4 brand-icon"></i>
          <span class="brand-text">Wyvern</span>
        </a>
      </div>
      <ul class="nav flex-column gap-1 sidebar-nav-list px-2">
        <li class="nav-item">
          <a class="nav-link <%= (typeof active !== 'undefined' && active === 'dashboard') ? 'active' : '' %>" href="/dashboard">
            <i class="bi bi-speedometer fs-4 me-2"></i> <span class="nav-text">Visão Geral</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link <%= (typeof active !== 'undefined' && active === 'campanhas') ? 'active' : '' %>" href="/campanhas">
            <i class="bi bi-book fs-4 me-2"></i> <span class="nav-text">Campanhas</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link <%= (typeof active !== 'undefined' && active === 'jogadores') ? 'active' : '' %>" href="/jogadores">
            <i class="bi bi-people-fill fs-4 me-2"></i> <span class="nav-text">Personagens</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link <%= (typeof active !== 'undefined' && active === 'sessoes') ? 'active' : '' %>" href="/sessoes">
            <i class="bi bi-calendar-event fs-4 me-2"></i> <span class="nav-text">Sessões</span>
          </a>
        </li>
      </ul>
    </aside>

    <div class="main-content flex-fill d-flex flex-column min-vh-100">
      
      <header class="topbar d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-link px-0" id="sidebarToggle" title="Expandir/Colapsar Menu">
            <i class="bi bi-list fs-3"></i>
        </button>
        <h1 class="m-0" style="font-family:'Cinzel',serif; letter-spacing:.5px;">
            <%= (typeof titulo !== 'undefined' && titulo)
                ? titulo
                : ((typeof title !== 'undefined' && title) ? title : '') %>
        </h1>
    </div>
    <div class="d-flex align-items-center gap-3">
        <span class="text-muted small">v0.1</span>
        
        <button id="logoutButton" class="btn btn-link px-2 text-danger" title="Sair da Conta">
            <i class="bi bi-box-arrow-right fs-4"></i>
        </button>
        <div class="avatar bg-primary-subtle text-primary fw-bold"></div>
    </div>
</header>

      <main class="content container-fluid py-4 flex-grow-1">
        <% const hasFlash = (typeof flash !== 'undefined') && flash; %>
        <% if (hasFlash && (flash.success || flash.info || flash.warning || flash.danger)) { %>
          <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080;">
            <% if (flash.success) { %>
              <div class="toast align-items-center text-bg-success border-0 show mb-2"><div class="d-flex">
                <div class="toast-body"><%= flash.success %></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div></div>
            <% } %>
            <% if (flash.info) { %>
              <div class="toast align-items-center text-bg-primary border-0 show mb-2"><div class="d-flex">
                <div class="toast-body"><%= flash.info %></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div></div>
            <% } %>
            <% if (flash.warning) { %>
              <div class="toast align-items-center text-bg-warning border-0 show mb-2"><div class="d-flex">
                <div class="toast-body"><%= flash.warning %></div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
              </div></div>
            <% } %>
            <% if (flash.danger) { %>
              <div class="toast align-items-center text-bg-danger border-0 show mb-2"><div class="d-flex">
                <div class="toast-body"><%= flash.danger %></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div></div>
            <% } %>
          </div>
        <% } %>

        <%- body %>
      </main>

      <footer class="footer text-center small text-muted py-3">
        © <%= new Date().getFullYear() %> Wyvern
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script src="/js/app.js?v=4"></script> 

  <script>
    (function(){
      const appShell = document.getElementById('appShell');
      const toggle = document.getElementById('sidebarToggle');
      const logoutButton = document.getElementById('logoutButton');

      // --- 1. Lógica do Sidebar ---
      // Recupera o estado salvo
      try {
        const saved = localStorage.getItem('ui:sidebarClosed');
        if (saved === '1') appShell.classList.add('sidebar-closed');
      } catch {}

      if (toggle && appShell) {
        toggle.addEventListener('click', () => {
          appShell.classList.toggle('sidebar-closed');
          try {
            localStorage.setItem('ui:sidebarClosed',
              appShell.classList.contains('sidebar-closed') ? '1' : '0');
          } catch {}
        });
      }

      // --- 2. Lógica do Logout ---
      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja encerrar a sessão?')) {
                return;
            }

            try {
                // Faz a requisição POST para a rota /logout no seu servidor
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    // SE O BACKEND RETORNA SUCESSO, REDIRECIONA PARA A TELA DE LOGIN
                    window.location.href = '/login'; 
                } else {
                    console.error('Logout failed with status:', response.status);
                    alert('Erro ao tentar sair. Por favor, tente novamente. Status: ' + response.status);
                }
            } catch (error) {
                console.error('Erro de rede durante o logout:', error);
                alert('Não foi possível conectar ao servidor para fazer logout.');
            }
        });
      }

    })();
  </script>
</body>
</html>