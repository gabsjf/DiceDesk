<link rel="stylesheet" href="/css/jogar.css?v=13">

<div class="jogar-container">
  <aside class="jogar-sidebar">
    <h6>Ferramentas</h6>

    <div class="tool-group">
      <button class="tool" data-bs-toggle="modal" data-bs-target="#modal-personagem">
        <i class="bi bi-person-plus"></i> Adicionar personagem
      </button>

      <% if (sessao && sessao.combat && sessao.combat.active) { %>
        <form class="d-grid" method="post" action="/sessoes/<%= sessao.id %>/combat/finish">
          <input type="hidden" name="xpTotal" id="xpTotalSidebar">
          <button type="submit" class="tool">
            <i class="bi bi-flag-fill"></i> Finalizar combate
          </button>
        </form>
      <% } else { %>
        <button class="tool" id="btnStartCombat">
          <i class="bi bi-lightning-charge"></i> Iniciar combate
        </button>
      <% } %>

      <button
        class="tool"
        id="btnOpenNotes"
        data-bs-toggle="modal"
        data-bs-target="#modal-notas"
        data-session-id="<%= campanhaId %>"
        data-session-title="<%= (sessao && (sessao.titulo || sessao.nome)) ? (sessao.titulo || sessao.nome) : 'Sess√£o' %>">
        <i class="bi bi-journal-text"></i> Anota√ß√µes
      </button>
    </div>

    <div class="sidebar-spacer"></div>

    <form action="/campanhas/<%= campanhaId %>" method="get">
      <button type="submit" class="btn-finish-session">
        <i class="bi bi-x-lg me-2"></i> Finalizar sess√£o
      </button>
    </form>
  </aside>

  <main class="jogar-main">
    <div class="jogar-header">
      <h2><i class="bi bi-controller me-2"></i><%= (sessao && (sessao.titulo || sessao.nome)) ? (sessao.titulo || sessao.nome) : 'Sess√£o' %></h2>
      <span class="sub">
        <% if (sessao && sessao.createdAt) { %>
          Criada em <%= new Date(sessao.createdAt).toLocaleDateString() %>
        <% } %>
      </span>
    </div>

    <% if (sessao && sessao.combat && sessao.combat.active) { 
          const activeP = sessao.combat.order[sessao.combat.turnIndex];
          const activeId = activeP?.idRef;
    %>
      <div class="card mb-3">
        <div class="card-body d-flex align-items-center gap-2 flex-wrap">
          <span class="badge text-bg-dark">Round <%= sessao.combat.round %></span>
          <span class="badge text-bg-primary">Turno de <strong><%= activeP?.name || "‚Äî" %></strong></span>

          <div class="ms-auto d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-danger btn-pill btn-attack" type="button">
              <i class="bi bi-crosshair me-1"></i> Atacar
            </button>
            <button class="btn btn-outline-success btn-pill btn-heal" type="button">
              <i class="bi bi-heart me-1"></i> Curar
            </button>
            <button class="btn btn-outline-primary btn-pill btn-cond" type="button">
              <i class="bi bi-magic me-1"></i> Condi√ß√£o
            </button>
            <form method="post" action="/sessoes/<%= sessao.id %>/combat/action" class="d-inline">
              <input type="hidden" name="type" value="end_turn">
              <button class="btn btn-primary btn-pill" type="submit">
                <i class="bi bi-skip-end-fill me-1"></i> Pr√≥ximo turno
              </button>
            </form>
          </div>
        </div>
      </div>

      <div id="combatScroll" class="combat-scroll">
        <div class="combat-grid row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xxl-4 g-3 mb-0">
          <% (sessao.combat.order || []).forEach(p => { 
                const isActive = String(p.idRef) === String(activeId);
                const hpPct = p.hpMax ? Math.max(0, Math.round((p.hp / p.hpMax) * 100)) : 0;
                
                let hpColorClass = 'bg-success'; // 100% - 50%
                if (hpPct < 50 && hpPct >= 20) { hpColorClass = 'bg-warning'; } // 49% - 20%
                else if (hpPct < 20) { hpColorClass = 'bg-danger'; } // 19% - 0%
          %>
            <div class="col">
              <div class="card h-100 <%= isActive ? 'turn-active' : 'turn-inactive' %>">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0"><%= p.name %></h5>
                    <span class="badge <%= p.type === 'PC' ? 'text-bg-success' : 'text-bg-secondary' %> badge-chip"><%= p.type %></span>
                  </div>

                  <div class="small text-muted mb-2">Init <%= p.init %> ‚Ä¢ N√≠vel <%= p.level || 0 %> ‚Ä¢ CA <%= p.ca || '‚Äî' %></div>

                  <div class="mb-2">
                    <strong>HP</strong>:
                    <%= p.hp %> / <%= p.hpMax %>
                    <div class="progress mt-1" style="height:8px;">
                      <div class="progress-bar <%= hpColorClass %>" role="progressbar" style="width: <%= hpPct %> %"></div>
                    </div>
                  </div>

                  <div class="mb-0">
                    <strong>Condi√ß√µes</strong>:
                    <% if ((p.conditions||[]).length === 0) { %>
                      <span class="text-muted">nenhuma</span>
                    <% } else { %>
                      <div class="d-flex flex-wrap gap-1">
                        <% (p.conditions || []).forEach(c => { %>
                          <form method="post" action="/sessoes/<%= sessao.id %>/combat/action" class="d-inline">
                            <input type="hidden" name="type" value="condition_remove">
                            <input type="hidden" name="sourceId" value="<%= activeId %>">
                            <input type="hidden" name="targetId" value="<%= p.idRef %>">
                            <input type="hidden" name="condition" value="<%= c %>">
                            <button class="badge text-bg-warning text-dark border-0" title="Remover condi√ß√£o <%= c %>">
                              <%= c %> &times;
                            </button>
                          </form>
                        <% }) %>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
      <div class="card combat-footer mt-3">
        <div class="card-body d-flex align-items-center gap-2">
          <form class="d-flex align-items-center gap-2 ms-auto" method="post" action="/sessoes/<%= sessao.id %>/combat/finish">
            <label class="form-label mb-0">XP total</label>
            <input name="xpTotal" id="xpTotalFooter" type="number" min="0" class="form-control" style="width:140px;" placeholder="ex.: 1800">
            <input type="hidden" name="combatOrderJson" id="combatOrderJson" value='<%= JSON.stringify(sessao.combat.order) %>'>
            <button class="btn btn-warning"><i class="bi bi-flag-fill me-1"></i> Finalizar combate</button>
          </form>
        </div>
      </div>

    <% } else { %>
      <div class="party-grid" id="partyGrid"></div>
    <% } %>
  </main>
</div>

<div class="modal fade" id="modal-personagem" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content arc-card" id="formPersonagem">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title">Personagem</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="personagem-id">
        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control" id="personagem-nome" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="personagem-tipo">
            <option value="pc">Player (PC)</option>
            <option value="npc">NPC</option>
          </select>
        </div>
        <div class="row g-3">
          <div class="col-4">
            <label class="form-label">N√≠vel (opcional)</label>
            <input type="number" min="1" class="form-control" id="personagem-nivel" placeholder="ex.: 3">
          </div>
          <div class="col-4">
            <label class="form-label">CA (opcional)</label>
            <input type="number" min="0" class="form-control" id="personagem-ca" placeholder="ex.: 15">
          </div>
          <div class="col-4">
            <label class="form-label">HP M√°ximo</label>
            <input type="number" min="1" class="form-control" id="personagem-hp-max" required placeholder="PV total">
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="btn btn-ring" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modal-dados" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content arc-card">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title">Rolar dados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <select class="form-select" id="dice-type">
            <option value="20">d20</option>
            <option value="12">d12</option>
            <option value="10">d10</option>
            <option value="8">d8</option>
            <option value="6">d6</option>
            <option value="4">d4</option>
          </select>
        </div>
        <button class="btn btn-dice" id="rollDiceBtn">Rolar</button>
        <div class="dice-result mt-3" id="diceResult"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-combate" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content arc-card">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title">Ordem de iniciativa (Insira o valor)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group ini-list" id="iniList"></ul>
      </div>
      <div class="modal-footer border-top-0">
        <button class="btn btn-ring" id="prevTurn">‚óÄ Anterior</button>
        <button class="btn btn-primary" id="nextTurn">Pr√≥ximo ‚ñ∂</button>
        <button class="btn btn-success" id="confirmStart"><i class="bi bi-lightning-charge me-1"></i> Iniciar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-acao" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content arc-card" id="formAcao" method="post" action="/sessoes/<%= sessao?.id %>/combat/action">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title" id="acaoTitulo">A√ß√£o</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="type" id="acaoType" value="damage">
        <input type="hidden" name="sourceId" id="acaoSourceId" value="">
        <div class="mb-3">
          <label class="form-label">Alvo</label>
          <select class="form-select" name="targetId" id="acaoTargetId"></select>
        </div>
        <div class="mb-3">
          <label class="form-label" id="acaoLabel">Dano</label>
          <input type="number" min="0" name="amount" id="acaoAmount" class="form-control" placeholder="valor">
        </div>
        <div class="form-text" id="acaoHint"></div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="btn btn-ring" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit" id="acaoSubmit">Aplicar</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modal-cond" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content arc-card" id="formCondAdd" method="post" action="/sessoes/<%= sessao?.id %>/combat/action">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title" id="condTitulo">Adicionar condi√ß√£o</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="type" value="condition_add">
        <input type="hidden" name="sourceId" id="condSourceId" value="">
        <div class="mb-3">
          <label class="form-label">Alvo</label>
          <select class="form-select" name="targetId" id="condTargetId"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">Condi√ß√£o</label>
          <select name="condition" class="form-select" id="condSelect">
            <% (typeof conditions !== 'undefined' && conditions ? conditions : [
              "Amedrontado","Atordoado","Ca√≠do","Cego","Enfeiti√ßado","Envenenado","Exausto",
              "Imobilizado","Inconsciente","Incapacitado","Invis√≠vel","Paralisado","Petrificado","Surdo","Agarra do","Contido"
            ]).forEach(c => { %>
              <option value="<%= c %>"><%= c %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="btn btn-ring" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Adicionar</button>
      </div>
    </form>
  </div>
</div>

<% const campanha = { id: campanhaId, nome: (sessao && (sessao.titulo || sessao.nome)) ? (sessao.titulo || sessao.nome) : 'Sess√£o' }; %>
<%- include('../partials/_notas', { campanha }) %>

<script>
  (function() {
    // ‚úÖ Inje√ß√£o do ID da sess√£o vinda do backend
    const sessaoId = "<%= sessao.id %>";
    const storageKey = `party_${sessaoId}`;

    const personagensGrid = document.getElementById("personagens-grid");
    const formPersonagem = document.getElementById("form-personagem");
    const btnIniciarCombate = document.getElementById("btnIniciarCombate");

    // üîπ Recuperar personagens salvos
    function getParty() {
      return JSON.parse(localStorage.getItem(storageKey)) || [];
    }

    // üîπ Renderizar personagens na tela
    function renderParty() {
      personagensGrid.innerHTML = "";
      const party = getParty();

      if (party.length === 0) {
        personagensGrid.innerHTML = "<p class='text-center'>Nenhum personagem adicionado.</p>";
        return;
      }

      party.forEach(p => {
        const div = document.createElement("div");
        div.className = "col-md-3 personagem-card";
        div.innerHTML = `
          <h5>${p.name}</h5>
          <p>${p.isPc ? "Jogador" : "NPC"}</p>
          <p>CA: ${p.ca ?? "-"}</p>
          <p>HP: ${p.hpCurrent}/${p.hpMax}</p>
          <button class="botao-remover" data-id="${p.id}">Remover</button>
        `;
        personagensGrid.appendChild(div);
      });

      // üîπ Bot√µes de remover
      document.querySelectorAll(".botao-remover").forEach(btn => {
        btn.addEventListener("click", e => {
          const id = e.target.getAttribute("data-id");
          let party = getParty();
          party = party.filter(p => p.id != id);
          localStorage.setItem(storageKey, JSON.stringify(party));
          renderParty();
        });
      });
    }

    // üîπ Adicionar/atualizar personagem
    if (formPersonagem) {
      formPersonagem.addEventListener("submit", e => {
        e.preventDefault();
        const data = new FormData(formPersonagem);
        const nome = data.get("nome");
        const tipo = data.get("tipo");
        const nivel = parseInt(data.get("nivel"));
        const ca = parseInt(data.get("ca"));
        const hpMax = parseInt(data.get("hpMax"));
        const hpCurrent = parseInt(data.get("hpCurrent"));

        let party = getParty();
        const existente = party.find(p => p.name === nome);

        if (existente) {
          // Atualiza personagem existente
          party = party.map(p => {
            if (p.name === nome) {
              const newHpCurrent = Math.min(hpCurrent, hpMax);
              return {
                id: p.id,
                name: nome,
                isPc: tipo === "pc",
                nivel: nivel ?? null,
                ca: ca ?? null,
                hpMax: hpMax,
                hpCurrent: newHpCurrent
              };
            }
            return p;
          });
        } else {
          // Adiciona novo personagem
          const novo = {
            id: Date.now(),
            name: nome,
            isPc: tipo === "pc",
            nivel: nivel ?? null,
            ca: ca ?? null,
            hpMax: hpMax,
            hpCurrent: hpCurrent
          };
          party.push(novo);
        }

        localStorage.setItem(storageKey, JSON.stringify(party));
        renderParty();
        formPersonagem.reset();

        const modal = bootstrap.Modal.getInstance(document.getElementById("modal-personagem"));
        modal.hide();
      });
    }

    // üîπ Bot√£o Iniciar Combate
    if (btnIniciarCombate) {
      btnIniciarCombate.addEventListener("click", () => {
        const party = getParty();
        if (party.length === 0) {
          alert("Adicione personagens antes de iniciar o combate!");
          return;
        }

        // ‚úÖ Envia dados pro backend
        fetch(`/sessoes/${sessaoId}/combat/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            order: party,
            roundStart: 1
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("Combate iniciado!");
          } else {
            alert(`Erro: ${data.message}`);
          }
        })
        .catch(err => {
          console.error("Erro ao iniciar combate:", err);
          alert("Erro ao iniciar combate no servidor.");
        });
      });
    }

    renderParty();
  })();
</script>
